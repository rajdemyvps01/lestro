name: Yasmin

on:
  workflow_dispatch:
  repository_dispatch:

concurrency:
  group: marin-vps
  cancel-in-progress: true

permissions:
  actions: write
  contents: write

env:
  TZ: 'Asia/Kolkata'

jobs:
  ultimate-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 200

    steps:
    - name: üìÇ Checkout Code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: üü¢ Setup Node.js 22
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: ü•ü Setup Bun Runtime
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: üßπ System Cleanup & Install Pro Tools
      run: |
        echo "üßπ Clearing Disk Space..."
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force

        # Added python3 and python3-pip for yt-dlp
        sudo apt-get install -y -qq ffmpeg imagemagick webp jq tmate neofetch ttyd btop python3 python3-pip
        
        # --- üì• YT-DLP INSTALLATION ---
        echo "üì• Installing yt-dlp..."
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp
        
        sudo apt-get update -qq
        sudo apt-get install -y -qq ffmpeg imagemagick webp jq tmate neofetch ttyd btop
        
        # üõ°Ô∏è INSTALL & DEEP CLEAN JUNK (Code 2 logic)
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
        # Ye command bot folder ke andar se bhi installer ko uda degi
        find . -name "cloudflared-linux-amd64.deb" -type f -delete
        
        sudo npm install -g pm2
        curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | sudo bash
        ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519

    - name: üíæ Setup Ghost Auto-Save (savecode)
      run: |
        git config --global user.email "marin-bot@auto.sync"
        git config --global user.name "Marin Auto-Saver"
        git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
        
        echo "**/node_modules/" >> .gitignore
        echo "**/*.log" >> .gitignore
        echo "filebrowser.db" >> .gitignore
        
        mv .github /tmp/.github_hidden
        
        echo '#!/bin/bash' > savecode
        echo 'echo "‚è≥ Saving ALL BOTS to GitHub..."' >> savecode
        echo 'mv /tmp/.github_hidden ./.github' >> savecode 
        echo 'git add .' >> savecode
        echo 'git commit -m "üíæ Auto-saved Multi-Bot Empire [skip ci]" || echo "No changes to save."' >> savecode
        echo 'git push origin HEAD || echo "‚ö†Ô∏è Push failed! Check PAT_TOKEN."' >> savecode
        echo 'mv ./.github /tmp/.github_hidden' >> savecode 
        echo 'echo "‚úÖ Save Process Completed for all bots!"' >> savecode
        
        sudo mv savecode /usr/local/bin/savecode
        sudo chmod +x /usr/local/bin/savecode

    - name: üîí Set SSH Password
      run: |
        echo "runner:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
        sudo usermod -aG sudo runner

    # --- üöÄ ADVANCED MULTI-BOT ENGINE ---
    - name: üöÄ Auto-Detect & Start All Bots (PM2)
      env:
        MONGODB: ${{ secrets.MONGODB }}
        MODS: ${{ secrets.MODS }}
        SESSION_ID: ${{ secrets.SESSION_ID }}
        PACKNAME: ${{ secrets.PACKNAME }}
      run: |
        echo "üîç Scanning for Bot Folders..."
        BOT_LIST=""
        
        for dir in */ ; do
          if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
            BOT_NAME=$(basename "$dir")
            
            if [ -z "$BOT_LIST" ]; then
              BOT_LIST="$BOT_NAME"
            else
              BOT_LIST="$BOT_LIST, $BOT_NAME"
            fi
            
            echo "‚öôÔ∏è Initializing Bot: $BOT_NAME"
            cd "$dir"
            
            # Use Bun for installation if specified in package.json engines
            if grep -q '"bun":' package.json; then
              echo "ü•ü Bun detected, installing with Bun..."
              bun install
              
              # Start with smol engine if it is a main.js project
              if [ -f "src/main.js" ]; then
                pm2 start "bun run --smol src/main.js" --name "$BOT_NAME"
              else
                pm2 start "bun start" --name "$BOT_NAME"
              fi
            else
              echo "üü¢ Node detected, installing with NPM..."
              npm install
              if [ -f "index.js" ]; then
                pm2 start index.js --name "$BOT_NAME"
              else
                pm2 start npm --name "$BOT_NAME" -- start
              fi
            fi
            cd ..
          fi
        done
        pm2 save
        echo "ACTIVE_BOTS=${BOT_LIST:-'No bots found!'}" >> $GITHUB_ENV

    # --- üåê OPEN WEB PANELS SETUP (Code 2 Stability) ---
    - name: üåê Start Open Web Panels & Btop
      run: |
        set +e 
        
        # üõ°Ô∏è ULTRA STABLE STARTUP: No complex hide flags to prevent 502
        # DB is in /tmp so it won't show in your folders
        filebrowser -a 0.0.0.0 -p 8080 -r . --noauth -d /tmp/filebrowser.db > /tmp/filebrowser.log 2>&1 &
        
        ttyd -R -p 61208 btop > /tmp/btop.log 2>&1 &
        
        # Give services enough time to breathe
        sleep 20
        
        cloudflared tunnel --url http://127.0.0.1:8080 > /tmp/cf_file.log 2>&1 &
        cloudflared tunnel --url http://127.0.0.1:61208 > /tmp/cf_btop.log 2>&1 &
        
        # Extra time for tunnel mapping
        sleep 30
        
        FILE_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' /tmp/cf_file.log | head -n 1)
        BTOP_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' /tmp/cf_btop.log | head -n 1)
        
        echo "FILE_MANAGER_URL=${FILE_URL:-'‚ö†Ô∏è Wait & Refresh'}" >> $GITHUB_ENV
        echo "BTOP_URL=${BTOP_URL:-'‚ö†Ô∏è Wait & Refresh'}" >> $GITHUB_ENV

    # --- üîÑ TMATE SSH & OPEN ALERT ---
    - name: üîÑ Start Tmate Loop & Discord Alert
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        set +e 
        
        for i in {1..15}; do
           tmate -S /tmp/tmate.sock kill-session 2>/dev/null || true
           tmate -S /tmp/tmate.sock new-session -d
           tmate -S /tmp/tmate.sock wait tmate-ready
           sleep 5
           
           SSH_MSG=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null)
           
           if [[ "$SSH_MSG" == *"tmate.io"* ]]; then
              
              PAYLOAD=$(jq -n \
                --arg ssh "$SSH_MSG" \
                --arg fileUrl "$FILE_MANAGER_URL" \
                --arg btopUrl "$BTOP_URL" \
                --arg bots "$ACTIVE_BOTS" \
                '{content: "‚ú® üéÄ **VPS ùêÉùêöùê¨ùê°ùêõùê®ùêöùê´ùêù** üéÄ ‚ú®\n\n‚úÖ **ùêíùê≠ùêöùê≠ùêÆùê¨:** `Online` üü¢\nü§ñ **ùêÄùêúùê≠ùê¢ùêØùêû ùêÅùê®ùê≠ùê¨:** `\($bots)`\n\nüìÇ **ùêÖùê¢ùê•ùêû ùêåùêöùêßùêöùê†ùêûùê´:** \($fileUrl)\nüìä **ùêïùêèùêí ùêáùêûùêöùê•ùê≠ùê°:** \($btopUrl)\nüíª **ùêíùêíùêá ùêìùêûùê´ùê¶ùê¢ùêßùêöùê•:** `\($ssh)`\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüõ†Ô∏è **ùêïùêèùêí ùêåùêÄùêçùêÄùêÜùêÑùêåùêÑùêçùêì ùêÜùêîùêàùêÉùêÑ** üõ†Ô∏è\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüíæ **ùêíùêöùêØùêû ùêÇùê°ùêöùêßùê†ùêûùê¨:** `savecode` \n_(‚ö† Required before session ends to save data to GitHub!)_\n\nüì¶ **ùêîùêßùê≥ùê¢ùê© ùêÅùê®ùê≠:** `unzip \"filename.zip\"` \n_(Use this to extract your uploaded bot files)_\n\nüóëÔ∏è **ùêÇlean ùêâùêÆùêßùê§:** `rm \"filename.zip\"` \n_(Always delete zip files after unzip to save space)_\n\nüìù **ùêïùê¢ùêûùê∞ ùêãùê®ùê†ùê¨:** `pm2 logs Name` \n_(Check QR code or bot errors live)_\n\nüîÑ **ùêëùêûùê¨ùê≠ùêöùê´ùê≠:** `pm2 restart Name` \n_(Apply new code changes immediately)_\n\nüõë **ùêíùê≠ùê®ùê© ùêÅùê®ùê≠:** `pm2 stop Name` \n_(To turn off a specific bot)_\n\nüìà **ùêíùê≠ùêöùê≠ùêÆùê¨:** `pm2 status` \n_(To see all running bots list)_\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚ú® **üí° ùêìùê¢ùê©:** _If  You Have Any Issue Connect With Owner https://wa.me/918434573266 !_ "}')
              
              curl -H "Content-Type: application/json" -d "$PAYLOAD" $DISCORD_WEBHOOK
              
              echo "RESTART_SAFE=true" >> $GITHUB_ENV
              
              for m in {1..36}; do sleep 300; done
              
              savecode || true
              exit 0
           fi
           sleep 5
        done
        
        curl -H "Content-Type: application/json" -d '{"content": "‚ùå **ERROR:** Tmate Server failed. Auto-restart paused."}' $DISCORD_WEBHOOK
        exit 1

    - name: üßü Respawn Zombie
      if: env.RESTART_SAFE == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'marin.yml',
            ref: 'main'
          })
